<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2D Adventure</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        canvas {
            display: block;
            margin: auto;
            background-color: #000;
            max-width: 100%;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
        }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<script type="module">
    import TileManager from './TileManager.js';
    import KeyHandler from './KeyHandler.js';
    import CollisionChecker from './CollisionChecker.js';
    import AssetSetter from '../config/AssetSetter.js';
    import UI from './UI.js';
    import EventHandler from './Eventhandler.js';
    import Player from './Player.js';

    // ðŸ”¹ AWS Amplify Setup
    import { Amplify, API, graphqlOperation } from 'aws-amplify';
    import awsconfig from './aws-exports.js';
    import { updatePlayer, createPlayer } from './graphql/mutations.js';
    Amplify.configure(awsconfig);

    async function syncPlayerToCloud(player) {
        if (!player.id) return;
        try {
            await API.graphql(graphqlOperation(updatePlayer, {
                input: {
                    id: player.id,
                    username: player.username,
                    positionX: player.worldX,
                    positionY: player.worldY,
                    health: player.health
                }
            }));
        } catch (err) {
            console.error("Failed to sync player:", err);
        }
    }

    async function registerPlayer(username) {
        try {
            const id = crypto.randomUUID();
            const result = await API.graphql(graphqlOperation(createPlayer, {
                input: {
                    id: id,
                    username: username,
                    positionX: 0,
                    positionY: 0,
                    health: 100
                }
            }));
            return result.data.createPlayer;
        } catch (err) {
            console.error("Failed to register player:", err);
        }
    }

    class GamePanel {
        constructor(canvas) {
            // SCREEN SETTINGS
            this.originalTileSize = 16;
            this.scale = 3;
            this.tileSize = this.originalTileSize * this.scale;
            this.maxScreenCol = 40;
            this.maxScreenRow = 23;
            this.screenWidth = this.tileSize * this.maxScreenCol;
            this.screenHeight = this.tileSize * this.maxScreenRow;
            this.maxMap = 10;
            this.currentMap = 0;

            // Set canvas size
            canvas.width = this.screenWidth;
            canvas.height = this.screenHeight;
            this.canvas = canvas;
            this.ctx = canvas.getContext('2d');

            this.playState = 1;
            this.pauseState = 2;
            this.dialogueState = 3;
            this.gameOverState = 4;
            this.gameState = this.playState;

            this.keyH = new KeyHandler(this);
            this.player = new Player(this, this.keyH);
            this.tileM = new TileManager(this);
            this.cChecker = new CollisionChecker(this);
            this.aSetter = new AssetSetter(this);
            this.ui = new UI(this);
            this.eHandler = new EventHandler(this);

            this.obj = Array.from({ length: this.maxMap }, () => Array(10).fill(null));
            this.npc = Array.from({ length: this.maxMap }, () => Array(10).fill(null));
            this.monster = Array.from({ length: this.maxMap }, () => Array(20).fill(null));

            this.FPS = 60;
            this.deltaTime = 0;
            this.lastTime = 0;
        }

        async setUpGame() {
            // ðŸ”¹ Register player once game starts
            const registered = await registerPlayer("Player1");
            if (registered) {
                this.player.id = registered.id;
                this.player.username = registered.username;
            }

            this.aSetter.setObject();
            this.aSetter.setNPC();
            this.aSetter.setMonster();
            this.gameState = this.playState;
        }

        startGameThread() {
            const gameLoop = async (currentTime) => {
                this.deltaTime = (currentTime - this.lastTime) / 1000;
                this.lastTime = currentTime;
                if (this.deltaTime > 0.1) this.deltaTime = 0.1;

                this.update();
                this.draw();

                requestAnimationFrame(gameLoop);
            };

            requestAnimationFrame(gameLoop);
        }

        update() {
            if (this.gameState === this.playState) {
                this.player.update();
                syncPlayerToCloud(this.player);

                this.npc[this.currentMap]?.forEach(npc => {
                    if (npc) npc.update();
                });

                this.monster[this.currentMap] = this.monster[this.currentMap].filter(monster => {
                    if (monster) {
                        if (monster.alive || monster.dying) {
                            monster.update();
                            return true;
                        }
                        return false;
                    }
                    return false;
                });
            }
        }

        draw() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.tileM.draw(this.ctx);
            this.obj[this.currentMap]?.forEach(object => object?.draw(this.ctx, this));
            this.npc[this.currentMap]?.forEach(npc => npc?.draw(this.ctx));
            this.monster[this.currentMap]?.forEach(monster => monster?.draw(this.ctx));
            this.player.draw(this.ctx);
            this.ui.draw(this.ctx);
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('gameCanvas');
        const gamePanel = new GamePanel(canvas);
        gamePanel.setUpGame();
        gamePanel.startGameThread();
    });
</script>

</body>
</html>
