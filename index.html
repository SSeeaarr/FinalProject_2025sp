<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Final Quest - 2D Adventure</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: #000;
        }
        
        /* PIXELATED FOREST BACKGROUND */
        body {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 64 64"><rect width="64" height="64" fill="%23113311"/><path d="M8,48 L16,32 L24,48 Z" fill="%23225522"/><path d="M32,56 L40,36 L48,56 Z" fill="%23225522"/><path d="M16,60 L24,44 L32,60 Z" fill="%23227722"/><path d="M40,44 L48,28 L56,44 Z" fill="%23227722"/><path d="M0,36 L8,16 L16,36 Z" fill="%23227722"/><path d="M20,32 L28,12 L36,32 Z" fill="%23225522"/><rect x="8" y="48" width="4" height="16" fill="%23553311"/><rect x="36" y="56" width="4" height="8" fill="%23553311"/><rect x="20" y="60" width="4" height="4" fill="%23553311"/><rect x="44" y="44" width="4" height="12" fill="%23553311"/><rect x="4" y="36" width="4" height="12" fill="%23553311"/><rect x="24" y="32" width="4" height="12" fill="%23553311"/></svg>');
            background-repeat: repeat;
            background-size: 128px 128px;
            image-rendering: pixelated;
        }
        
        canvas {
            display: none;
            margin: auto;
            background-color: #000;
            max-width: 100%;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        
        /* Auth Container */
        .auth-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
        
        h2 {
            margin-bottom: 20px;
            text-align: center;
            color: #113311;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        form {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        
        input {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
            margin-bottom: 12px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        input:focus {
            border-color: #227722;
            outline: none;
            box-shadow: 0 0 5px rgba(34, 119, 34, 0.3);
        }
        
        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            background-color: #227722;
            color: white;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #113311;
        }
        
        a {
            color: #227722;
            text-decoration: none;
            font-size: 14px;
            text-align: center;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        #message {
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            text-align: center;
        }
        
        #confirmPasswordField input,
        #confirmCodeField input {
            width: 100%;
        }
        
        #confirmPasswordField,
        #confirmCodeField {
            display: none;
        }
        
        #resendCodeBtn {
            margin-top: 10px;
            background-color: #6c757d;
        }
        
        #resendCodeBtn:hover {
            background-color: #5a6268;
        }
        
        /* Character Selection Screen */
        .character-select {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            text-align: center;
            z-index: 50;
        }
        
        .character-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .character-option {
            width: 150px;
            cursor: pointer;
            transition: transform 0.2s;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .character-option:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .character-option.selected {
            border: 3px solid #227722;
            background: rgba(240, 255, 240, 0.9);
        }
        
        .character-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 10px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            background: #f0f0f0;
            border: 2px solid #113311;
        }
        
        .knight-icon { background-color: #b0c4de; }
        .mage-icon { background-color: #add8e6; }
        .archer-icon { background-color: #90ee90; }
        .gambler-icon { background-color: #ffb6c1; }
        
        .character-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .character-desc {
            font-size: 12px;
            color: #555;
            height: 50px;
            overflow: hidden;
        }
        
        .start-button {
            margin-top: 30px;
            padding: 15px 30px;
            background-color: #227722;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .start-button:hover {
            background-color: #113311;
        }
        
        .character-input {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
            width: 80%;
            max-width: 300px;
        }
        
        /* Pixel art character placeholders */
        .pixel-character {
            image-rendering: pixelated;
            width: 80px;
            height: 80px;
        }
    </style>
</head>
<body>
    <!-- Auth Container (Login/Signup) -->
    <div class="auth-container" id="authContainer">
        <h2 id="formTitle">Login to Final Quest</h2>
        <form id="authForm">
            <input type="email" id="email" name="email" placeholder="Email" required />
            <input type="password" id="password" name="password" placeholder="Password" required />

            <div id="confirmPasswordField">
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm Password" />
            </div>

            <button type="submit" id="submitBtn">Login</button>

            <div id="confirmCodeField">
                <input type="text" id="confirmCode" name="confirmCode" placeholder="Confirmation Code" />
                <button type="button" id="confirmCodeBtn">Confirm Account</button>
                <button type="button" id="resendCodeBtn">Resend Code</button>
            </div>
            <p id="message"></p>
        </form>
        <a href="#" id="toggleMode">Don't have an account? Sign up</a>
    </div>

    <!-- Character Selection Screen -->
    <div class="character-select" id="characterSelect">
        <h2>Choose Your Hero</h2>
        <input type="text" class="character-input" id="characterName" placeholder="Enter your character's name" required>
        
        <div class="character-options">
            <div class="character-option" data-class="Knight">
                <div class="character-icon knight-icon">
                    <svg class="pixel-character" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <rect x="6" y="2" width="4" height="2" fill="#333"/>
                        <rect x="5" y="4" width="6" height="2" fill="#888"/>
                        <rect x="4" y="6" width="8" height="2" fill="#888"/>
                        <rect x="6" y="8" width="4" height="2" fill="#888"/>
                        <rect x="5" y="10" width="6" height="2" fill="#888"/>
                        <rect x="4" y="12" width="3" height="2" fill="#333"/>
                        <rect x="9" y="12" width="3" height="2" fill="#333"/>
                    </svg>
                </div>
                <div class="character-name">Knight</div>
                <div class="character-desc">Strong defense and melee attacks. Starts with a sword and shield.</div>
            </div>
            
            <div class="character-option" data-class="Mage">
                <div class="character-icon mage-icon">
                    <svg class="pixel-character" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <rect x="7" y="1" width="2" height="2" fill="#333"/>
                        <rect x="6" y="3" width="4" height="1" fill="#44F"/>
                        <rect x="5" y="4" width="6" height="2" fill="#44F"/>
                        <rect x="7" y="6" width="2" height="4" fill="#44F"/>
                        <rect x="5" y="10" width="6" height="2" fill="#44F"/>
                        <rect x="4" y="12" width="3" height="2" fill="#44F"/>
                        <rect x="9" y="12" width="3" height="2" fill="#44F"/>
                    </svg>
                </div>
                <div class="character-name">Mage</div>
                <div class="character-desc">Powerful spells and magic abilities. Weak defense but high damage.</div>
            </div>
            
            <div class="character-option" data-class="Archer">
                <div class="character-icon archer-icon">
                    <svg class="pixel-character" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <rect x="7" y="2" width="2" height="2" fill="#333"/>
                        <rect x="5" y="4" width="6" height="2" fill="#484"/>
                        <rect x="4" y="6" width="8" height="2" fill="#484"/>
                        <rect x="7" y="8" width="2" height="2" fill="#484"/>
                        <rect x="5" y="10" width="6" height="2" fill="#484"/>
                        <rect x="4" y="12" width="3" height="2" fill="#484"/>
                        <rect x="9" y="12" width="3" height="2" fill="#484"/>
                    </svg>
                </div>
                <div class="character-name">Archer</div>
                <div class="character-desc">Long-range attacks and high accuracy. Balanced speed and damage.</div>
            </div>
            
            <div class="character-option" data-class="Gambler">
                <div class="character-icon gambler-icon">
                    <svg class="pixel-character" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <rect x="7" y="2" width="2" height="2" fill="#333"/>
                        <rect x="5" y="4" width="6" height="2" fill="#844"/>
                        <rect x="4" y="6" width="8" height="2" fill="#844"/>
                        <rect x="7" y="8" width="2" height="2" fill="#844"/>
                        <rect x="5" y="10" width="6" height="2" fill="#844"/>
                        <rect x="4" y="12" width="3" height="2" fill="#844"/>
                        <rect x="9" y="12" width="3" height="2" fill="#844"/>
                    </svg>
                </div>
                <div class="character-name">Gambler</div>
                <div class="character-desc">Unpredictable abilities with high risk and reward. Luck-based powers.</div>
            </div>
        </div>
        
        <button class="start-button" id="startGameBtn">Start Adventure</button>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/aws-amplify/dist/aws-amplify.min.js"></script>
    <script>
        // AWS Authentication Setup
        const Amplify = window.aws_amplify.Amplify;
        const Auth = window.aws_amplify.Auth;

        Amplify.configure({
            Auth: {
                region: "us-east-2",
                userPoolId: "us-east-2_Czl1ZsXp1",
                userPoolWebClientId: "5oer0age0upepjc0m5loutffso"
            }
        });

        // Replace with your actual API Gateway URL
        const API_URL = 'https://rg4amcl67a.execute-api.us-east-2.amazonaws.com/dev';

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const characterSelect = document.getElementById('characterSelect');
        const form = document.getElementById('authForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const confirmPasswordField = document.getElementById('confirmPasswordField');
        const message = document.getElementById('message');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const toggleMode = document.getElementById('toggleMode');
        const confirmCodeField = document.getElementById('confirmCodeField');
        const confirmCodeInput = document.getElementById('confirmCode');
        const confirmCodeBtn = document.getElementById('confirmCodeBtn');
        const resendCodeBtn = document.getElementById('resendCodeBtn');
        const characterName = document.getElementById('characterName');
        const startGameBtn = document.getElementById('startGameBtn');
        const characterOptions = document.querySelectorAll('.character-option');
        
        let isSignUp = false;
        let selectedClass = null;

        // Hide confirm code section and confirm password field on load
        confirmCodeField.style.display = 'none';
        confirmPasswordField.style.display = 'none';
        resendCodeBtn.style.display = 'none';

        // Authentication Event Listeners
        toggleMode.addEventListener('click', (e) => {
            e.preventDefault();
            isSignUp = !isSignUp;
            formTitle.textContent = isSignUp ? "Sign Up for Final Quest" : "Login to Final Quest";
            submitBtn.textContent = isSignUp ? "Sign Up" : "Login";
            toggleMode.textContent = isSignUp
                ? "Already have an account? Log in"
                : "Don't have an account? Sign up";

            confirmPasswordField.style.display = isSignUp ? 'block' : 'none';
            confirmPasswordInput.required = isSignUp;
            confirmPasswordInput.disabled = !isSignUp;
            confirmCodeField.style.display = 'none';
            resendCodeBtn.style.display = 'none';
            message.textContent = '';

            if (!isSignUp) {
                confirmPasswordInput.value = '';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            message.textContent = '';
            const email = emailInput.value;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (isSignUp) {
                if (password !== confirmPassword) {
                    message.textContent = "Passwords do not match.";
                    message.style.color = "red";
                    return;
                }

                try {
                    await Auth.signUp({
                        username: email,
                        password,
                        attributes: { email }
                    });
                    message.textContent = "Sign up successful! Please check your email to confirm.";
                    message.style.color = "green";
                    confirmCodeField.style.display = 'flex';
                    resendCodeBtn.style.display = 'block';
                } catch (err) {
                    message.textContent = "Error: " + err.message;
                    message.style.color = "red";
                }

            } else {
                try {
                    // Try to sign in
                    await Auth.signIn(email, password);
                    
                    // Success message
                    message.textContent = "Login successful! Preparing your adventure...";
                    message.style.color = "green";
                    
                    // Disable the form to prevent multiple submissions
                    submitBtn.disabled = true;
                    
                    // Smooth transition to party screen
                    setTimeout(() => {
                        // Hide the auth container with a fade effect
                        authContainer.style.opacity = '0';
                        setTimeout(() => {
                            authContainer.style.display = 'none';
                            
                            // Show party screen instead of character selection
                            const partyContainer = showPartyScreen();
                            // Fade in the party screen
                            setTimeout(() => {
                                partyContainer.style.opacity = '1';
                            }, 50);
                        }, 500);
                    }, 1000);
                    
                } catch (err) {
                    message.textContent = "Error: " + err.message;
                    message.style.color = "red";
                }
            }
        });

        confirmCodeBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const code = confirmCodeInput.value;

            try {
                await Auth.confirmSignUp(email, code);
                message.textContent = "Account confirmed! You can now log in.";
                message.style.color = "green";
                confirmCodeField.style.display = "none";
                resendCodeBtn.style.display = 'none';
                isSignUp = false;
                formTitle.textContent = "Login to Final Quest";
                submitBtn.textContent = "Login";
                toggleMode.textContent = "Don't have an account? Sign up";
                confirmPasswordField.style.display = 'none';
            } catch (err) {
                message.textContent = "Confirmation error: " + err.message;
                message.style.color = "red";
            }
        });

        resendCodeBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            message.textContent = 'Resending code...';
            message.style.color = 'orange';
            try {
                await Auth.resendSignUp(email);
                message.textContent = 'Verification code resent to your email.';
                message.style.color = 'green';
            } catch (err) {
                message.textContent = 'Error resending code: ' + err.message;
                message.style.color = 'red';
            }
        });

        // Character Selection Event Listeners
        characterOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Remove selected class from all options
                characterOptions.forEach(opt => opt.classList.remove('selected'));
                // Add selected class to clicked option
                option.classList.add('selected');
                // Store selected class
                selectedClass = option.getAttribute('data-class');
            });
        });

        startGameBtn.addEventListener('click', () => {
            const name = characterName.value.trim();
            
            if (!name) {
                alert('Please enter a character name');
                return;
            }
            
            if (!selectedClass) {
                alert('Please select a character class');
                return;
            }
            
            // Disable the button to prevent multiple clicks
            startGameBtn.disabled = true;
            
            // Transition to game with fade effect
            characterSelect.style.opacity = '0';
            setTimeout(() => {
                characterSelect.style.display = 'none';
                
                // Show loading message
                const loadingMessage = document.createElement('div');
                loadingMessage.textContent = `Preparing adventure for ${name} the ${selectedClass}...`;
                loadingMessage.style.position = 'absolute';
                loadingMessage.style.top = '50%';
                loadingMessage.style.left = '50%';
                loadingMessage.style.transform = 'translate(-50%, -50%)';
                loadingMessage.style.color = 'white';
                loadingMessage.style.fontSize = '20px';
                loadingMessage.style.textAlign = 'center';
                loadingMessage.id = 'loadingMessage';
                document.body.appendChild(loadingMessage);
                
                // Initialize the game with party information
                import('./game.js').then(gameModule => {
                    gameModule.initializeGame(
                        name, 
                        selectedClass, 
                        window.gamePartyMembers || [], 
                        window.gamePartyId || null
                    );
                }).catch(error => {
                    console.error("Error loading game module:", error);
                    alert("Error loading game. Please refresh the page.");
                });
            }, 500);
        });

        // For development/testing: Allow skipping login
        // Comment this out for production
        /*
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                authContainer.style.display = 'none';
                characterSelect.style.display = 'block';
            }
        });
        */

        // Add this after login but before showing character selection
        function showPartyScreen() {
            // Create party container
            const partyContainer = document.createElement('div');
            partyContainer.className = 'auth-container';
            partyContainer.id = 'partyContainer';
            partyContainer.style.maxWidth = '500px';
            
            // Create HTML content for party screen
            partyContainer.innerHTML = `
                <h2>Adventure Party</h2>
                <div class="party-options">
                    <button id="createPartyBtn" class="party-button">Create New Party</button>
                    <button id="joinPartyBtn" class="party-button">Join Existing Party</button>
                </div>
                
                <div id="partyCreated" style="display: none;">
                    <h3>Your Party (ID: <span id="partyCode"></span>)</h3>
                    <p>Share this code with friends to join your party</p>
                    <div id="partyMembers" class="party-members">
                        <!-- Party members will be listed here -->
                    </div>
                    <button id="startPartyGame" class="start-button" disabled>Start Adventure (Waiting for Players)</button>
                </div>
                
                <div id="joinPartyForm" style="display: none;">
                    <input type="text" id="partyCodeInput" placeholder="Enter Party Code" class="character-input">
                    <button id="confirmJoinBtn" class="party-button">Join Party</button>
                </div>
                
                <p id="partyMessage"></p>
            `;
            
            document.body.appendChild(partyContainer);
            
            // Add styles for party system
            const style = document.createElement('style');
            style.textContent = `
                .party-options {
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    margin-bottom: 20px;
                }
                
                .party-button {
                    padding: 15px;
                    font-size: 16px;
                }
                
                .party-members {
                    background: rgba(255, 255, 255, 0.8);
                    border-radius: 8px;
                    padding: 10px;
                    margin: 15px 0;
                    min-height: 150px;
                    max-height: 250px;
                    overflow-y: auto;
                }
                
                .party-member {
                    display: flex;
                    align-items: center;
                    padding: 8px;
                    border-bottom: 1px solid #eee;
                }
                
                .party-member:last-child {
                    border-bottom: none;
                }
                
                .party-member-host {
                    background-color: rgba(34, 119, 34, 0.2);
                }
                
                .party-member-icon {
                    width: 30px;
                    height: 30px;
                    margin-right: 10px;
                    border-radius: 50%;
                    background-color: #f0f0f0;
                }
                
                .party-member-name {
                    flex-grow: 1;
                }
                
                .party-member-status {
                    font-size: 12px;
                    color: #666;
                }
            `;
            document.head.appendChild(style);
            
            // Party system logic - add event listeners
            setupPartyLogic();
            
            return partyContainer;
        }

        // Add this function to handle party system logic
        function setupPartyLogic() {
            // DOM elements
            const createPartyBtn = document.getElementById('createPartyBtn');
            const joinPartyBtn = document.getElementById('joinPartyBtn');
            const partyCreated = document.getElementById('partyCreated');
            const joinPartyForm = document.getElementById('joinPartyForm');
            const partyCode = document.getElementById('partyCode');
            const partyCodeInput = document.getElementById('partyCodeInput');
            const confirmJoinBtn = document.getElementById('confirmJoinBtn');
            const partyMembers = document.getElementById('partyMembers');
            const startPartyGame = document.getElementById('startPartyGame');
            const partyMessage = document.getElementById('partyMessage');
            
            // Party data
            let currentParty = null;
            let isPartyHost = false;
            let partyCheckInterval = null;
            let currentUser = null;
            
            // Get current user info
            Auth.currentAuthenticatedUser().then(user => {
                currentUser = {
                    id: user.username,
                    email: user.attributes.email,
                    name: user.attributes.email.split('@')[0] // Default name from email
                };
            });
            
            // Create new party
            createPartyBtn.addEventListener('click', async () => {
                try {
                    // Generate unique party ID
                    const partyId = Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    // Create party in DynamoDB via API
                    const party = await createPartyInDatabase(partyId);
                    
                    // Update UI
                    partyCode.textContent = partyId;
                    partyCreated.style.display = 'block';
                    document.querySelector('.party-options').style.display = 'none';
                    
                    currentParty = party;
                    isPartyHost = true;
                    
                    // Add self to party members
                    addPartyMember(currentUser, true);
                    
                    // Start checking for party updates
                    startPartyUpdates(partyId);
                    
                    partyMessage.textContent = "Party created! Share the code with friends.";
                    partyMessage.style.color = "green";
                } catch (error) {
                    partyMessage.textContent = "Error creating party: " + error.message;
                    partyMessage.style.color = "red";
                }
            });
            
            // Join existing party
            joinPartyBtn.addEventListener('click', () => {
                document.querySelector('.party-options').style.display = 'none';
                joinPartyForm.style.display = 'block';
            });
            
            // Confirm join party
            confirmJoinBtn.addEventListener('click', async () => {
                const partyId = partyCodeInput.value.trim().toUpperCase();
                
                if (!partyId) {
                    partyMessage.textContent = "Please enter a party code";
                    partyMessage.style.color = "red";
                    return;
                }
                
                try {
                    // Join party in database
                    const party = await joinPartyInDatabase(partyId);
                    
                    // Update UI
                    joinPartyForm.style.display = 'none';
                    partyCreated.style.display = 'block';
                    partyCode.textContent = partyId;
                    
                    currentParty = party;
                    isPartyHost = false;
                    
                    // Start checking for party updates
                    startPartyUpdates(partyId);
                    
                    partyMessage.textContent = "Joined party successfully!";
                    partyMessage.style.color = "green";
                } catch (error) {
                    partyMessage.textContent = "Error joining party: " + error.message;
                    partyMessage.style.color = "red";
                }
            });
            
            // Start game (host only)
            startPartyGame.addEventListener('click', () => {
                if (!isPartyHost) return;
                
                // Update party status to "starting"
                updatePartyStatus(currentParty.id, "starting").then(() => {
                    // Proceed to character selection
                    const partyContainer = document.getElementById('partyContainer');
                    partyContainer.style.opacity = '0';
                    
                    // Store the party ID to pass to the game
                    const partyId = currentParty.id;
                    
                    setTimeout(() => {
                        partyContainer.remove();
                        characterSelect.style.display = 'block';
                        
                        // Store party data in local storage or a global variable
                        window.gamePartyId = partyId;
                        window.gamePartyMembers = currentParty.members;
                        
                        setTimeout(() => {
                            characterSelect.style.opacity = '1';
                        }, 50);
                    }, 500);
                });
            });
            
            // Helper function to add a party member to the UI
            function addPartyMember(member, isHost) {
                const memberElement = document.createElement('div');
                memberElement.className = `party-member ${isHost ? 'party-member-host' : ''}`;
                memberElement.dataset.id = member.id;
                
                memberElement.innerHTML = `
                    <div class="party-member-icon"></div>
                    <div class="party-member-name">${member.name || member.email}</div>
                    <div class="party-member-status">${isHost ? 'Host' : 'Ready'}</div>
                `;
                
                partyMembers.appendChild(memberElement);
                
                // Enable start button if we're the host and have at least one member
                if (isPartyHost && partyMembers.children.length > 0) {
                    startPartyGame.disabled = false;
                    startPartyGame.textContent = "Start Adventure";
                }
            }
            
            // Helper function to check for party updates
            function startPartyUpdates(partyId) {
                // Clear any existing interval
                if (partyCheckInterval) clearInterval(partyCheckInterval);
                
                // Update party data every 3 seconds
                partyCheckInterval = setInterval(async () => {
                    try {
                        const updatedParty = await getPartyFromDatabase(partyId);
                        
                        // Update member list
                        if (updatedParty.members) {
                            // Clear current members
                            partyMembers.innerHTML = '';
                            
                            // Add updated members
                            updatedParty.members.forEach(member => {
                                addPartyMember(member, member.id === updatedParty.hostId);
                            });
                        }
                        
                        // Check if game is starting
                        if (updatedParty.status === "starting" && !isPartyHost) {
                            clearInterval(partyCheckInterval);

                            // Set the global partyId so it is available for initializeGame
                            window.gamePartyId = updatedParty.id;

                            const partyContainer = document.getElementById('partyContainer');
                            partyContainer.style.opacity = '0';

                            setTimeout(() => {
                                partyContainer.remove();
                                characterSelect.style.display = 'block';
                                setTimeout(() => {
                                    characterSelect.style.opacity = '1';
                                }, 50);
                            }, 500);
                        }
                        
                        currentParty = updatedParty;
                    } catch (error) {
                        console.error("Error updating party:", error);
                    }
                }, 3000);
            }
        }

        // Party Database Functions
        async function createPartyInDatabase(partyId) {
            try {
                const Auth = window.aws_amplify.Auth;
                const user = await Auth.currentAuthenticatedUser();
                const token = user.signInUserSession.idToken.jwtToken;
                
                const partyData = {
                    id: partyId,
                    hostId: user.username,
                    status: "waiting",
                    members: [{
                        id: user.username,
                        email: user.attributes.email,
                        name: user.attributes.email.split('@')[0] // Default name
                    }],
                    createdAt: new Date().toISOString()
                };
                
                // Call your API Gateway endpoint to save party
                const response = await fetch(`${API_URL}/parties`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(partyData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create party');
                }
                
                // Return the party data, not an API Gateway response structure
                return partyData;
            } catch (error) {
                console.error('Error creating party:', error);
                throw error;
            }
        }

        async function joinPartyInDatabase(partyId) {
            try {
                const Auth = window.aws_amplify.Auth;
                const user = await Auth.currentAuthenticatedUser();
                const token = user.signInUserSession.idToken.jwtToken;
                
                // Get current party data
                const party = await getPartyFromDatabase(partyId);
                
                // Make sure party.members exists
                if (!party.members) {
                    party.members = [];
                }
                
                // Add new member
                const newMember = {
                    id: user.username,
                    email: user.attributes.email,
                    name: user.attributes.email.split('@')[0] // Default name
                };
                
                // Check if already a member
                const existingMember = party.members.find(m => m.id === user.username);
                if (!existingMember) {
                    party.members.push(newMember);
                }
                
                // Update party in database
                const response = await fetch(`${API_URL}/parties/${partyId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(party)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to join party');
                }
                
                // Return the party object directly
                return party;
            } catch (error) {
                console.error('Error joining party:', error);
                throw error;
            }
        }

        async function getPartyFromDatabase(partyId) {
            try {
                const Auth = window.aws_amplify.Auth;
                const user = await Auth.currentAuthenticatedUser();
                const token = user.signInUserSession.idToken.jwtToken;
                
                // Get party from database
                const response = await fetch(`${API_URL}/parties/${partyId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to get party: ${response.status}`);
                }
                
                const responseData = await response.json();
                
                
                // Handle the various response formats we might get
                let partyData;
                
                // Case 1: Direct party data
                if (responseData.id && responseData.members) {
                    partyData = responseData;
                }
                // Case 2: API Gateway response with body as string
                else if (responseData.body && typeof responseData.body === 'string') {
                    try {
                        partyData = JSON.parse(responseData.body);
                    } catch (e) {
                        console.error("Error parsing response body:", e);
                        throw new Error('Failed to parse API response body');
                    }
                }
                // Case 3: API Gateway response with body as object
                else if (responseData.body && typeof responseData.body === 'object') {
                    partyData = responseData.body;
                }
                // Case 4: API Gateway success response wrapping the party
                else if (responseData.statusCode === 200) {
                    // The party data might be directly in responseData
                    partyData = responseData;
                }
                else {
                    console.error("Unexpected API response format:", responseData);
                    throw new Error('Invalid response format from API');
                }
                
                // Ensure we have a valid party object
                if (!partyData || typeof partyData !== 'object') {
                    throw new Error('No valid party data returned from API');
                }
                
                // Always ensure members array exists
                if (!partyData.members) {
                    partyData.members = [];
                }
                
                return partyData;
            } catch (error) {
                console.error('Error getting party:', error);
                throw error;
            }
        }

        async function updatePartyStatus(partyId, status) {
            try {
                const Auth = window.aws_amplify.Auth;
                const user = await Auth.currentAuthenticatedUser();
                const token = user.signInUserSession.idToken.jwtToken;
                
                // Get current party data
                const party = await getPartyFromDatabase(partyId);
                
                // Update status
                party.status = status;
                
                // Update party in database
                const response = await fetch(`${API_URL}/parties/${partyId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(party)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update party');
                }
                
                // Return the party object directly, not API Gateway structure
                return party;
            } catch (error) {
                console.error('Error updating party:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
